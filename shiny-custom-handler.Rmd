# Custom handlers: from R to JavaScript {#shiny-custom-handler}

## Introduction
Shiny provides tools to ease the communication between R and JavaScript, as illustrated in section \@ref(shiny-websocket). How does R send messages to JavaScript?

We already discussed the usage of `sendInputMessage()` in the input binding section \@ref(shiny-input-system). The other important method is `sendCustomMessage(type, message)`. It works by pair with the JS method `Shiny.AddCustomMessageHandler`, linked with the type parameter.

```{r, eval=FALSE}
say_hello_to_js <- function(text, session = getDefaultReactiveDomain()) {
  session$sendCustomMessage(type = 'say-hello', message = text)
}
```

The JavaScript receptor is defined below:

```javascript
$(function() {
  Shiny.AddCustomMessageHandler('say-hello', function(message) {
    alert(`R says ${message} to you!`)
  });
});
```

The shiny app below will simply print a welcome message every 5 seconds. We obviously set `options(shiny.trace = TRUE)`. Figure \@ref(fig:shiny-custom-message) summarizes the main mechanisms involved in the R to JS communication. The corresponding code may be found [here](https://github.com/DivadNojnarg/outstanding-shiny-ui-code/blob/master/R/say_hello.R).

```{r, eval=FALSE}
shinyAppDir(system.file("chapter6/say_hello", package = "OSUICode"))
```

You will find a whole chapter dedicated to custom handlers here \@ref(custom-templates-interactivity).

```{r shiny-custom-message, echo=FALSE, fig.cap='From R to JavaScript', out.width='100%'}
knitr::include_graphics("images/survival-kit/shiny-custom-message.png")
```

Combining `Shiny.setInputValue`, `Shiny.addCustomMessageHandler`, here is a fun example
that sets the body background as a result of a simple button click.
We defined 3 JS pieces:

  - `getPokemon` whose script is adapted from Colin Fay et al. (see [here](https://engineering-shiny.org/optimjs.html)). This function fetch the [pokeapi](https://pokeapi.co/)
  data and if successful set an input value, which will be available on the R side
  - An event listener is set to the only button of the page so that each time we click,
  we call `getPokemon` to select a random background image
  - `input$pokeData` is actually a quite complex list (deeply nested JSON) and some manipulation is done from R in the `observeEvent` block. Once done, we send the data
  back to JS through the websocket (the session object sends a message). 
  - On the JS side, the last block is a custom message handler that will add some inline
  CSS properties to the body element


```{r, eval=FALSE}
library(shiny)

ui <- fluidPage(
  tags$script(
    HTML(
      "$(function() {
        // Taken from Colin
        const getPokemon = () => {
          // FETCHING THE API DATA
          let randId = Math.floor(Math.random() * (+151 + 1 - +1)) + +1;
          fetch('https://pokeapi.co/api/v2/pokemon/' + randId)
          // DEFINE WHAT HAPPENS WHEN JAVASCRIPT RECEIVES THE DATA
          .then((data) =>{
            // TURN THE DATA TO JSON
            data.json().then((res) => {
              // SEND THE JSON TO R
              Shiny.setInputValue('pokeData', res, {priority: 'event'})
            })
          })
          // DEFINE WHAT HAPPENS WHEN THERE IS AN ERROR FETCHING THE API
          .catch((error) => {
            alert('Error catching result from API')
          })
        };
        
        // add event listener
        $('#button').on('click', function() {
          getPokemon();
        });
        
        // update background based on R data
        Shiny.addCustomMessageHandler('update_background', function(message) {
          $('body').css({
            'background-image':'url(' + message +')', 
            'background-repeat':'no-repeat'
          });
        });
        
      });
      "
    )
  ),
  tags$button(id = "button", "Go!", class = "btn-success")
)

server <- function(input, output, session) {
  
  observeEvent(input$pokeData, {
    background <- input$pokeData$sprites$other$`official-artwork`$front_default
    message(background)
    session$sendCustomMessage(type = "update_background", message = background)
  })
}

shinyApp(ui, server)
```

## Dynamically insert content

## Simple HTML

## HTML with extra dependencies
TO DO: talk about `Shiny.renderHtml`, `Shiny.renderContent`

### Example

User messages in `{shinydashboardPlus}` (latest devel version).

```javascript
// userMessages
  // ------------------------------------------------------------------
  // This code creates acustom handler for userMessages
  Shiny.addCustomMessageHandler("user-messages", function(message) {
    var id = message.id, action = message.action, content = message.body, index = message.index;
    
    // message text
    // We use Shiny.renderHtml to handle the case where the user pass input/outputs in the updated content that require a new dependency not available in the 
    // page at startup. 
    if (content.hasOwnProperty("text")) {
      var text;
      if (content.text.html === undefined) {
        text = content.text;
      } else {
        text = Shiny.renderHtml(content.text.html, $([]), content.text.deps).html;
      } 
    }
    
    // unbind all
    Shiny.unbindAll();
    
    if (action === "remove") {
      $("#" + id).find(".direct-chat-msg").eq(index - 1).remove();
    } else if (action === "add") {
      var author = content.author, date = content.date, image = content.image, type = content.type;
      
      // build the new message 
      var newMessage = '<div class="direct-chat-info clearfix">' +
        '<span class="direct-chat-name">' + author + '</span>' +
        '<span class="direct-chat-timestamp" style="margin-left: 4px">' + date + '</span>' + '</div>' +
        '<img class="direct-chat-img" src="' + image + '"/>' + 
        '<div class="direct-chat-text">' + text + '</div>'
        
      // build wrapper
      var newMessageWrapper;
      if (type === "sent") {
        newMessageWrapper = '<div class="direct-chat-msg right">' + newMessage + '</div>'
      } else {
        newMessageWrapper = '<div class="direct-chat-msg">' + newMessage + '</div>'
      }
      
      // append message
      $("#" + id).find(".direct-chat-messages").append(newMessageWrapper);
    } else if (action === "update") {
      
      // today's date
      var d = new Date();
      var month = d.getMonth() + 1;
      var day = d.getDate();
      var today = d.getFullYear() + '/' +
        ((''+month).length<2 ? '0' : '') + month + '/' +
        ((''+day).length<2 ? '0' : '') + day;
        
      // we assume only text may be updated. Does not make sense to modify author/date
      
      $("#" + id)
        .find(".direct-chat-text")
        .eq(index - 1)
        .replaceWith('<div class="direct-chat-text"><small class="text-red">(modified: ' + today +')</small><br>' +  text + '</div>')
    }
    
    // Calls .initialize() for all of the input objects in all input bindings,
    // in the given scope (document)
    Shiny.initializeInputs();
    Shiny.bindAll(); // bind all inputs/outputs
  });
```

Shiny demo:

```{r, eval=FALSE}
library(shinydashboard)
library(shinydashboardPlus)
 
 shinyApp(
  ui = dashboardPage(
    dashboardHeader(),
    dashboardSidebar(),
    dashboardBody(
      fluidRow(
        actionButton("remove", "Remove message"),
        actionButton("add", "Add message"),
        actionButton("update", "Update message")
      ),
      numericInput("index", "Message index:", 1, min = 1, max = 3),
      br(),
      br(),
      userMessages(
        width = 6,
        status = "danger",
        id = "message",
        userMessage(
          author = "Alexander Pierce",
          date = "20 Jan 2:00 pm",
          image = "https://adminlte.io/themes/AdminLTE/dist/img/user1-128x128.jpg",
          type = "received",
          "Is this template really for free? That's unbelievable!"
        ),
        userMessage(
          author = "Sarah Bullock",
          date = "23 Jan 2:05 pm",
          image = "https://adminlte.io/themes/AdminLTE/dist/img/user3-128x128.jpg",
          type = "sent",
          "You better believe it!"
        )
      )
    ),
    title = "user Message"
  ),
  server = function(input, output, session) {
    observeEvent(input$remove, {
      updateUserMessages("message", action = "remove", index = input$index)
    })
    observeEvent(input$add, {
      updateUserMessages(
        "message", 
        action = "add", 
        content = list(
          author = "David",
          date = "Now",
          image = "https://i.pinimg.com/originals/f1/15/df/f115dfc9cab063597b1221d015996b39.jpg",
          type = "received",
          text = tagList(
           sliderInput(
            "obs", 
            "Number of observations:",
            min = 0, 
            max = 1000, 
            value = 500
           ),
           plotOutput("distPlot")
          )
        )
      )
    })
    
    output$distPlot <- renderPlot({
     hist(rnorm(input$obs))
    })
    
    observeEvent(input$update, {
      updateUserMessages(
        "message", 
        action = "update", 
        index = input$index,
        content = list(
         text = tagList(
          appButton(
           inputId = "reload",
           label = "Click me!", 
           icon = icon("sync"), 
           dashboardBadge(1, color = "orange")
          )
         )
        )
      )
    })
    
    observeEvent(input$reload, {
     showNotification("Yeah!", duration = 1, type = "default")
    })
  }
 )
```
