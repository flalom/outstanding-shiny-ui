<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 7 Shiny’s internal: session and websockets | Outstanding User Interfaces with Shiny</title>
  <meta name="description" content="A book about deeply customizing Shiny app for production." />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 7 Shiny’s internal: session and websockets | Outstanding User Interfaces with Shiny" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A book about deeply customizing Shiny app for production." />
  <meta name="github-repo" content="DivadNojnarg/outstanding-shiny-ui" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 7 Shiny’s internal: session and websockets | Outstanding User Interfaces with Shiny" />
  
  <meta name="twitter:description" content="A book about deeply customizing Shiny app for production." />
  

<meta name="author" content="David Granjon" />


<meta name="date" content="2020-10-26" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
<link rel="prev" href="survival-kit-javascript.html"/>
<link rel="next" href="shiny-input-system.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Outstanding User Interfaces with Shiny</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#disclaimer"><i class="fa fa-check"></i>Disclaimer</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#is-this-book-for-me"><i class="fa fa-check"></i>Is this book for me?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#learning-objectives"><i class="fa fa-check"></i>Learning objectives</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#why-another-shiny-related-book"><i class="fa fa-check"></i>Why another Shiny related book?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#book-structure"><i class="fa fa-check"></i>Book structure</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#code-structure"><i class="fa fa-check"></i>Code structure</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#preliminary-exercices"><i class="fa fa-check"></i>Preliminary exercices</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#extra-material"><i class="fa fa-check"></i>Extra material</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#e-rum-2020"><i class="fa fa-check"></i>e-Rum 2020</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#rpharma-2020"><i class="fa fa-check"></i>R/Pharma 2020</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-rinterface"><i class="fa fa-check"></i>About RinteRface</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#packages"><i class="fa fa-check"></i>Packages</a></li>
</ul></li>
<li class="part"><span><b>Introduction</b></span></li>
<li class="chapter" data-level="1" data-path="web-intro.html"><a href="web-intro.html"><i class="fa fa-check"></i><b>1</b> Shiny and the Web</a><ul>
<li class="chapter" data-level="1.1" data-path="web-intro.html"><a href="web-intro.html#shiny-generates-html-code-from-r"><i class="fa fa-check"></i><b>1.1</b> Shiny generates HTML code from R</a></li>
<li class="chapter" data-level="1.2" data-path="web-intro.html"><a href="web-intro.html#web-intro-html"><i class="fa fa-check"></i><b>1.2</b> HTML 101</a><ul>
<li class="chapter" data-level="1.2.1" data-path="web-intro.html"><a href="web-intro.html#html-basics"><i class="fa fa-check"></i><b>1.2.1</b> HTML Basics</a></li>
<li class="chapter" data-level="1.2.2" data-path="web-intro.html"><a href="web-intro.html#tag-attributes"><i class="fa fa-check"></i><b>1.2.2</b> Tag attributes</a></li>
<li class="chapter" data-level="1.2.3" data-path="web-intro.html"><a href="web-intro.html#the-simplest-html-skeleton"><i class="fa fa-check"></i><b>1.2.3</b> The simplest HTML skeleton</a></li>
<li class="chapter" data-level="1.2.4" data-path="web-intro.html"><a href="web-intro.html#about-the-document-object-model-dom"><i class="fa fa-check"></i><b>1.2.4</b> About the Document Object Model (DOM)</a></li>
<li class="chapter" data-level="1.2.5" data-path="web-intro.html"><a href="web-intro.html#preliminary-introduction-to-css-and-javascript"><i class="fa fa-check"></i><b>1.2.5</b> Preliminary introduction to CSS and JavaScript</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="web-dependencies.html"><a href="web-dependencies.html"><i class="fa fa-check"></i><b>2</b> Discover Shiny dependencies</a><ul>
<li class="chapter" data-level="2.1" data-path="web-dependencies.html"><a href="web-dependencies.html#introduction"><i class="fa fa-check"></i><b>2.1</b> Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="web-dependencies.html"><a href="web-dependencies.html#bootstrap"><i class="fa fa-check"></i><b>2.2</b> Bootstrap</a></li>
<li class="chapter" data-level="2.3" data-path="web-dependencies.html"><a href="web-dependencies.html#jquery-dom-manipulation"><i class="fa fa-check"></i><b>2.3</b> jQuery, DOM manipulation</a></li>
<li class="chapter" data-level="2.4" data-path="web-dependencies.html"><a href="web-dependencies.html#data-formating"><i class="fa fa-check"></i><b>2.4</b> Data formating</a></li>
<li class="chapter" data-level="2.5" data-path="web-dependencies.html"><a href="web-dependencies.html#custom-dependencies"><i class="fa fa-check"></i><b>2.5</b> Custom dependencies</a></li>
<li class="chapter" data-level="2.6" data-path="web-dependencies.html"><a href="web-dependencies.html#exercise"><i class="fa fa-check"></i><b>2.6</b> Exercise</a></li>
</ul></li>
<li class="part"><span><b>Unleash {htmltools}: from R to HTML</b></span></li>
<li class="chapter" data-level="3" data-path="htmltools-overview.html"><a href="htmltools-overview.html"><i class="fa fa-check"></i><b>3</b> htmltools overview</a><ul>
<li class="chapter" data-level="3.1" data-path="htmltools-overview.html"><a href="htmltools-overview.html#writing-html-tags-from-r"><i class="fa fa-check"></i><b>3.1</b> Writing HTML Tags from R</a></li>
<li class="chapter" data-level="3.2" data-path="htmltools-overview.html"><a href="htmltools-overview.html#notations"><i class="fa fa-check"></i><b>3.2</b> Notations</a></li>
<li class="chapter" data-level="3.3" data-path="htmltools-overview.html"><a href="htmltools-overview.html#adding-new-tags"><i class="fa fa-check"></i><b>3.3</b> Adding new tags</a></li>
<li class="chapter" data-level="3.4" data-path="htmltools-overview.html"><a href="htmltools-overview.html#alternative-way-to-write-tags"><i class="fa fa-check"></i><b>3.4</b> Alternative way to write tags</a></li>
<li class="chapter" data-level="3.5" data-path="htmltools-overview.html"><a href="htmltools-overview.html#playing-with-tags"><i class="fa fa-check"></i><b>3.5</b> Playing with tags</a><ul>
<li class="chapter" data-level="3.5.1" data-path="htmltools-overview.html"><a href="htmltools-overview.html#tags-structure"><i class="fa fa-check"></i><b>3.5.1</b> Tags structure</a></li>
<li class="chapter" data-level="3.5.2" data-path="htmltools-overview.html"><a href="htmltools-overview.html#useful-functions-for-tags"><i class="fa fa-check"></i><b>3.5.2</b> Useful functions for tags</a></li>
<li class="chapter" data-level="3.5.3" data-path="htmltools-overview.html"><a href="htmltools-overview.html#other-functions"><i class="fa fa-check"></i><b>3.5.3</b> Other functions</a></li>
<li class="chapter" data-level="3.5.4" data-path="htmltools-overview.html"><a href="htmltools-overview.html#conditionally-set-attributes"><i class="fa fa-check"></i><b>3.5.4</b> Conditionally set attributes</a></li>
<li class="chapter" data-level="3.5.5" data-path="htmltools-overview.html"><a href="htmltools-overview.html#using"><i class="fa fa-check"></i><b>3.5.5</b> Using %&gt;%</a></li>
<li class="chapter" data-level="3.5.6" data-path="htmltools-overview.html"><a href="htmltools-overview.html#programmatically-create-children-elements"><i class="fa fa-check"></i><b>3.5.6</b> Programmatically create children elements</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="htmltools-overview.html"><a href="htmltools-overview.html#exercises"><i class="fa fa-check"></i><b>3.6</b> Exercises</a><ul>
<li class="chapter" data-level="3.6.1" data-path="htmltools-overview.html"><a href="htmltools-overview.html#exercise-1-tags-structure-5-minutes"><i class="fa fa-check"></i><b>3.6.1</b> Exercise 1: tags structure (5 minutes)</a></li>
<li class="chapter" data-level="3.6.2" data-path="htmltools-overview.html"><a href="htmltools-overview.html#exercise-2-modifiying-tags-5-minutes"><i class="fa fa-check"></i><b>3.6.2</b> Exercise 2: modifiying tags (5 minutes)</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="htmltools-dependencies.html"><a href="htmltools-dependencies.html"><i class="fa fa-check"></i><b>4</b> Dependency utilities</a><ul>
<li class="chapter" data-level="4.1" data-path="htmltools-dependencies.html"><a href="htmltools-dependencies.html#the-dirty-approach"><i class="fa fa-check"></i><b>4.1</b> The dirty approach</a></li>
<li class="chapter" data-level="4.2" data-path="htmltools-dependencies.html"><a href="htmltools-dependencies.html#the-clean-approach"><i class="fa fa-check"></i><b>4.2</b> The clean approach</a></li>
<li class="chapter" data-level="4.3" data-path="htmltools-dependencies.html"><a href="htmltools-dependencies.html#another-example-importing-html-dependencies-from-other-packages"><i class="fa fa-check"></i><b>4.3</b> Another example: Importing HTML dependencies from other packages</a></li>
<li class="chapter" data-level="4.4" data-path="htmltools-dependencies.html"><a href="htmltools-dependencies.html#suppress-dependencies"><i class="fa fa-check"></i><b>4.4</b> Suppress dependencies</a></li>
<li class="chapter" data-level="4.5" data-path="htmltools-dependencies.html"><a href="htmltools-dependencies.html#resolve-dependencies"><i class="fa fa-check"></i><b>4.5</b> Resolve dependencies</a></li>
<li class="chapter" data-level="4.6" data-path="htmltools-dependencies.html"><a href="htmltools-dependencies.html#insert-custom-script-in-the-head"><i class="fa fa-check"></i><b>4.6</b> Insert Custom script in the head</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="htmltools-other-tools.html"><a href="htmltools-other-tools.html"><i class="fa fa-check"></i><b>5</b> Other tools</a><ul>
<li class="chapter" data-level="5.1" data-path="htmltools-other-tools.html"><a href="htmltools-other-tools.html#css"><i class="fa fa-check"></i><b>5.1</b> CSS</a></li>
</ul></li>
<li class="part"><span><b>Deep dive in the Shiny input system</b></span></li>
<li class="chapter" data-level="6" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html"><i class="fa fa-check"></i><b>6</b> JavaScript for Shiny</a><ul>
<li class="chapter" data-level="6.1" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#shiny-javascript-sources"><i class="fa fa-check"></i><b>6.1</b> Shiny JavaScript sources</a></li>
<li class="chapter" data-level="6.2" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#introduction-to-javascript"><i class="fa fa-check"></i><b>6.2</b> Introduction to JavaScript</a></li>
<li class="chapter" data-level="6.3" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#setup"><i class="fa fa-check"></i><b>6.3</b> Setup</a><ul>
<li class="chapter" data-level="6.3.1" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#node"><i class="fa fa-check"></i><b>6.3.1</b> Node</a></li>
<li class="chapter" data-level="6.3.2" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#choose-a-good-ide"><i class="fa fa-check"></i><b>6.3.2</b> Choose a good IDE</a></li>
<li class="chapter" data-level="6.3.3" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#first-script"><i class="fa fa-check"></i><b>6.3.3</b> First Script</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#programming-with-js-basis"><i class="fa fa-check"></i><b>6.4</b> Programming with JS: basis</a><ul>
<li class="chapter" data-level="6.4.1" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#js-types"><i class="fa fa-check"></i><b>6.4.1</b> JS types</a></li>
<li class="chapter" data-level="6.4.2" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#variables"><i class="fa fa-check"></i><b>6.4.2</b> Variables</a></li>
<li class="chapter" data-level="6.4.3" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#conditions"><i class="fa fa-check"></i><b>6.4.3</b> Conditions</a></li>
<li class="chapter" data-level="6.4.4" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#objects"><i class="fa fa-check"></i><b>6.4.4</b> Objects</a></li>
<li class="chapter" data-level="6.4.5" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#iterations"><i class="fa fa-check"></i><b>6.4.5</b> Iterations</a></li>
<li class="chapter" data-level="6.4.6" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#functions"><i class="fa fa-check"></i><b>6.4.6</b> Functions</a></li>
<li class="chapter" data-level="6.4.7" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#event-listeners"><i class="fa fa-check"></i><b>6.4.7</b> Event listeners</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#jquery"><i class="fa fa-check"></i><b>6.5</b> jQuery</a><ul>
<li class="chapter" data-level="6.5.1" data-path="web-dependencies.html"><a href="web-dependencies.html#introduction"><i class="fa fa-check"></i><b>6.5.1</b> Introduction</a></li>
<li class="chapter" data-level="6.5.2" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#syntax"><i class="fa fa-check"></i><b>6.5.2</b> Syntax</a></li>
<li class="chapter" data-level="6.5.3" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#useful-functions"><i class="fa fa-check"></i><b>6.5.3</b> Useful functions</a></li>
<li class="chapter" data-level="6.5.4" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#chaining-jquery-methods"><i class="fa fa-check"></i><b>6.5.4</b> Chaining jQuery methods</a></li>
<li class="chapter" data-level="6.5.5" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#iterations-1"><i class="fa fa-check"></i><b>6.5.5</b> Iterations</a></li>
<li class="chapter" data-level="6.5.6" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#good-practice"><i class="fa fa-check"></i><b>6.5.6</b> Good practice</a></li>
<li class="chapter" data-level="6.5.7" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#events"><i class="fa fa-check"></i><b>6.5.7</b> Events</a></li>
<li class="chapter" data-level="6.5.8" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#extending-objects"><i class="fa fa-check"></i><b>6.5.8</b> Extending objects</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#shiny-js-inspector"><i class="fa fa-check"></i><b>6.6</b> Shiny, JavaScript and the HTML inspector</a><ul>
<li class="chapter" data-level="6.6.1" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#the-console-panel"><i class="fa fa-check"></i><b>6.6.1</b> The console panel</a></li>
<li class="chapter" data-level="6.6.2" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#debug-shinyjs-code-with-the-inspector"><i class="fa fa-check"></i><b>6.6.2</b> Debug Shiny/JS code with the inspector</a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="htmltools-overview.html"><a href="htmltools-overview.html#exercises"><i class="fa fa-check"></i><b>6.7</b> Exercises</a><ul>
<li class="chapter" data-level="6.7.1" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#exercise-1-define-variables"><i class="fa fa-check"></i><b>6.7.1</b> Exercise 1: define variables</a></li>
<li class="chapter" data-level="6.7.2" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#exercise-2-define-objects"><i class="fa fa-check"></i><b>6.7.2</b> Exercise 2: define objects</a></li>
<li class="chapter" data-level="6.7.3" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#exercise-3-jquery"><i class="fa fa-check"></i><b>6.7.3</b> Exercise 3: jQuery</a></li>
<li class="chapter" data-level="6.7.4" data-path="survival-kit-javascript.html"><a href="survival-kit-javascript.html#exercise-4-a-pure-js-action-button"><i class="fa fa-check"></i><b>6.7.4</b> Exercise 4: a pure JS action button</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="shiny-intro.html"><a href="shiny-intro.html"><i class="fa fa-check"></i><b>7</b> Shiny’s internal: session and websockets</a><ul>
<li class="chapter" data-level="7.1" data-path="shiny-intro.html"><a href="shiny-intro.html#shiny-websocket"><i class="fa fa-check"></i><b>7.1</b> Websocket: R/JS bidirectional communication</a><ul>
<li class="chapter" data-level="7.1.1" data-path="shiny-intro.html"><a href="shiny-intro.html#shiny-websocket-server-side"><i class="fa fa-check"></i><b>7.1.1</b> Shiny: websocket server side</a></li>
<li class="chapter" data-level="7.1.2" data-path="shiny-intro.html"><a href="shiny-intro.html#shiny-websocket-client-side"><i class="fa fa-check"></i><b>7.1.2</b> Shiny: Websocket client side</a></li>
<li class="chapter" data-level="7.1.3" data-path="shiny-intro.html"><a href="shiny-intro.html#example"><i class="fa fa-check"></i><b>7.1.3</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="shiny-intro.html"><a href="shiny-intro.html#shiny-js-object"><i class="fa fa-check"></i><b>7.2</b> The Shiny JavaScript object</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="shiny-input-system.html"><a href="shiny-input-system.html"><i class="fa fa-check"></i><b>8</b> Shiny’s input system</a><ul>
<li class="chapter" data-level="8.1" data-path="shiny-input-system.html"><a href="shiny-input-system.html#input-bindings"><i class="fa fa-check"></i><b>8.1</b> Input bindings</a><ul>
<li class="chapter" data-level="8.1.1" data-path="shiny-input-system.html"><a href="shiny-input-system.html#input-structure"><i class="fa fa-check"></i><b>8.1.1</b> Input structure</a></li>
<li class="chapter" data-level="8.1.2" data-path="shiny-input-system.html"><a href="shiny-input-system.html#binding-shiny-inputs"><i class="fa fa-check"></i><b>8.1.2</b> Binding Shiny inputs</a></li>
<li class="chapter" data-level="8.1.3" data-path="shiny-input-system.html"><a href="shiny-input-system.html#edit-an-input-binding"><i class="fa fa-check"></i><b>8.1.3</b> Edit an input binding</a></li>
<li class="chapter" data-level="8.1.4" data-path="shiny-input-system.html"><a href="shiny-input-system.html#update-a-binding-from-the-client"><i class="fa fa-check"></i><b>8.1.4</b> Update a binding from the client</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="shiny-input-system.html"><a href="shiny-input-system.html#examples"><i class="fa fa-check"></i><b>8.2</b> Examples</a><ul>
<li class="chapter" data-level="8.2.1" data-path="shiny-input-system.html"><a href="shiny-input-system.html#shinydashboard-boxes-on-steroids"><i class="fa fa-check"></i><b>8.2.1</b> {shinydashboard} boxes on steroids</a></li>
<li class="chapter" data-level="8.2.2" data-path="shiny-input-system.html"><a href="shiny-input-system.html#going-further"><i class="fa fa-check"></i><b>8.2.2</b> Going further</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="shiny-input-system.html"><a href="shiny-input-system.html#utilities-to-quickly-define-new-inputs"><i class="fa fa-check"></i><b>8.3</b> Utilities to quickly define new inputs</a><ul>
<li class="chapter" data-level="8.3.1" data-path="web-dependencies.html"><a href="web-dependencies.html#introduction"><i class="fa fa-check"></i><b>8.3.1</b> Introduction</a></li>
<li class="chapter" data-level="8.3.2" data-path="shiny-input-system.html"><a href="shiny-input-system.html#examples-1"><i class="fa fa-check"></i><b>8.3.2</b> Examples</a></li>
<li class="chapter" data-level="8.3.3" data-path="shiny-input-system.html"><a href="shiny-input-system.html#custom-data-format"><i class="fa fa-check"></i><b>8.3.3</b> Custom data format</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="shiny-input-system.html"><a href="shiny-input-system.html#hidden-gems-about-inputs"><i class="fa fa-check"></i><b>8.4</b> Hidden gems about inputs</a><ul>
<li class="chapter" data-level="8.4.1" data-path="shiny-input-system.html"><a href="shiny-input-system.html#get-the-last-changed-input"><i class="fa fa-check"></i><b>8.4.1</b> Get the last changed input</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="shiny-input-system.html"><a href="shiny-input-system.html#recap-shiny-app-lifecycles"><i class="fa fa-check"></i><b>8.5</b> Recap: Shiny App lifecycles</a><ul>
<li class="chapter" data-level="8.5.1" data-path="shiny-input-system.html"><a href="shiny-input-system.html#app-initialization"><i class="fa fa-check"></i><b>8.5.1</b> App initialization</a></li>
<li class="chapter" data-level="8.5.2" data-path="shiny-input-system.html"><a href="shiny-input-system.html#update-input"><i class="fa fa-check"></i><b>8.5.2</b> Update input</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="shiny-custom-handler.html"><a href="shiny-custom-handler.html"><i class="fa fa-check"></i><b>9</b> Custom handlers: from R to JavaScript</a></li>
<li class="part"><span><b>Practice 1: a dashboard template</b></span></li>
<li class="chapter" data-level="10" data-path="custom-templates-selection.html"><a href="custom-templates-selection.html"><i class="fa fa-check"></i><b>10</b> Template selection</a></li>
<li class="chapter" data-level="11" data-path="custom-templates-dependencies.html"><a href="custom-templates-dependencies.html"><i class="fa fa-check"></i><b>11</b> Define dependencies</a><ul>
<li class="chapter" data-level="11.1" data-path="custom-templates-dependencies.html"><a href="custom-templates-dependencies.html#discover-the-project"><i class="fa fa-check"></i><b>11.1</b> Discover the project</a></li>
<li class="chapter" data-level="11.2" data-path="custom-templates-dependencies.html"><a href="custom-templates-dependencies.html#identify-mandatory-dependencies"><i class="fa fa-check"></i><b>11.2</b> Identify mandatory dependencies</a></li>
<li class="chapter" data-level="11.3" data-path="custom-templates-dependencies.html"><a href="custom-templates-dependencies.html#bundle-dependencies"><i class="fa fa-check"></i><b>11.3</b> Bundle dependencies</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="custom-templates-skeleton.html"><a href="custom-templates-skeleton.html"><i class="fa fa-check"></i><b>12</b> Template skeleton</a><ul>
<li class="chapter" data-level="12.1" data-path="custom-templates-skeleton.html"><a href="custom-templates-skeleton.html#identify-template-elements"><i class="fa fa-check"></i><b>12.1</b> Identify template elements</a></li>
<li class="chapter" data-level="12.2" data-path="custom-templates-skeleton.html"><a href="custom-templates-skeleton.html#design-the-page-layout"><i class="fa fa-check"></i><b>12.2</b> Design the page layout</a><ul>
<li class="chapter" data-level="12.2.1" data-path="custom-templates-skeleton.html"><a href="custom-templates-skeleton.html#the-page-wrapper"><i class="fa fa-check"></i><b>12.2.1</b> The page wrapper</a></li>
<li class="chapter" data-level="12.2.2" data-path="custom-templates-skeleton.html"><a href="custom-templates-skeleton.html#the-body-content"><i class="fa fa-check"></i><b>12.2.2</b> The body content</a></li>
<li class="chapter" data-level="12.2.3" data-path="custom-templates-skeleton.html"><a href="custom-templates-skeleton.html#the-footer"><i class="fa fa-check"></i><b>12.2.3</b> The footer</a></li>
<li class="chapter" data-level="12.2.4" data-path="custom-templates-skeleton.html"><a href="custom-templates-skeleton.html#the-navbar-or-header"><i class="fa fa-check"></i><b>12.2.4</b> The navbar (or header)</a></li>
<li class="chapter" data-level="12.2.5" data-path="custom-templates-skeleton.html"><a href="custom-templates-skeleton.html#card-containers"><i class="fa fa-check"></i><b>12.2.5</b> Card containers</a></li>
<li class="chapter" data-level="12.2.6" data-path="custom-templates-skeleton.html"><a href="custom-templates-skeleton.html#ribbons-card-components"><i class="fa fa-check"></i><b>12.2.6</b> Ribbons: card components</a></li>
<li class="chapter" data-level="12.2.7" data-path="custom-templates-skeleton.html"><a href="custom-templates-skeleton.html#icons"><i class="fa fa-check"></i><b>12.2.7</b> Icons</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="htmltools-overview.html"><a href="htmltools-overview.html#exercises"><i class="fa fa-check"></i><b>12.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="custom-templates-testing.html"><a href="custom-templates-testing.html"><i class="fa fa-check"></i><b>13</b> Testing and validating templates elements</a><ul>
<li class="chapter" data-level="13.1" data-path="custom-templates-testing.html"><a href="custom-templates-testing.html#validate-template-functions"><i class="fa fa-check"></i><b>13.1</b> Validate template functions</a><ul>
<li class="chapter" data-level="13.1.1" data-path="custom-templates-testing.html"><a href="custom-templates-testing.html#create-your-own-validations"><i class="fa fa-check"></i><b>13.1.1</b> Create your own validations</a></li>
<li class="chapter" data-level="13.1.2" data-path="custom-templates-testing.html"><a href="custom-templates-testing.html#existing-utils-functions"><i class="fa fa-check"></i><b>13.1.2</b> Existing utils functions</a></li>
<li class="chapter" data-level="13.1.3" data-path="custom-templates-testing.html"><a href="custom-templates-testing.html#example-refine-navbar-menu-items"><i class="fa fa-check"></i><b>13.1.3</b> Example: refine navbar menu items</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="custom-templates-testing.html"><a href="custom-templates-testing.html#testing-templates-elements"><i class="fa fa-check"></i><b>13.2</b> Testing templates elements</a><ul>
<li class="chapter" data-level="13.2.1" data-path="custom-templates-testing.html"><a href="custom-templates-testing.html#testing-template-behavior"><i class="fa fa-check"></i><b>13.2.1</b> Testing template behavior</a></li>
</ul></li>
<li class="chapter" data-level="13.3" data-path="custom-templates-testing.html"><a href="custom-templates-testing.html#testing-javascript"><i class="fa fa-check"></i><b>13.3</b> Testing JavaScript</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="custom-templates-inputs.html"><a href="custom-templates-inputs.html"><i class="fa fa-check"></i><b>14</b> Develop custom input widgets</a><ul>
<li class="chapter" data-level="14.1" data-path="custom-templates-inputs.html"><a href="custom-templates-inputs.html#tabler-action-button"><i class="fa fa-check"></i><b>14.1</b> Tabler action button</a><ul>
<li class="chapter" data-level="14.1.1" data-path="custom-templates-inputs.html"><a href="custom-templates-inputs.html#reminders-about-the-action-button"><i class="fa fa-check"></i><b>14.1.1</b> Reminders about the action button</a></li>
<li class="chapter" data-level="14.1.2" data-path="custom-templates-inputs.html"><a href="custom-templates-inputs.html#application-to-tabler"><i class="fa fa-check"></i><b>14.1.2</b> Application to Tabler</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="custom-templates-inputs.html"><a href="custom-templates-inputs.html#toggle-switch"><i class="fa fa-check"></i><b>14.2</b> Toggle Switch</a></li>
<li class="chapter" data-level="14.3" data-path="custom-templates-inputs.html"><a href="custom-templates-inputs.html#navbar-menu-input"><i class="fa fa-check"></i><b>14.3</b> Navbar menu input</a></li>
<li class="chapter" data-level="14.4" data-path="htmltools-overview.html"><a href="htmltools-overview.html#exercises"><i class="fa fa-check"></i><b>14.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="custom-templates-interactivity.html"><a href="custom-templates-interactivity.html"><i class="fa fa-check"></i><b>15</b> Adding more interactivity</a><ul>
<li class="chapter" data-level="15.1" data-path="custom-templates-interactivity.html"><a href="custom-templates-interactivity.html#custom-progress-bars"><i class="fa fa-check"></i><b>15.1</b> Custom progress bars</a></li>
<li class="chapter" data-level="15.2" data-path="custom-templates-interactivity.html"><a href="custom-templates-interactivity.html#user-feedback-toasts"><i class="fa fa-check"></i><b>15.2</b> User feedback: toasts</a><ul>
<li class="chapter" data-level="15.2.1" data-path="custom-templates-interactivity.html"><a href="custom-templates-interactivity.html#toast-skeleton"><i class="fa fa-check"></i><b>15.2.1</b> Toast skeleton</a></li>
<li class="chapter" data-level="15.2.2" data-path="custom-templates-interactivity.html"><a href="custom-templates-interactivity.html#the-toast-api"><i class="fa fa-check"></i><b>15.2.2</b> The toast API</a></li>
<li class="chapter" data-level="15.2.3" data-path="custom-templates-interactivity.html"><a href="custom-templates-interactivity.html#r-implementation"><i class="fa fa-check"></i><b>15.2.3</b> R implementation</a></li>
<li class="chapter" data-level="15.2.4" data-path="custom-templates-interactivity.html"><a href="custom-templates-interactivity.html#wrap-up"><i class="fa fa-check"></i><b>15.2.4</b> Wrap up</a></li>
</ul></li>
<li class="chapter" data-level="15.3" data-path="custom-templates-interactivity.html"><a href="custom-templates-interactivity.html#transform-an-element-in-a-custom-action-button"><i class="fa fa-check"></i><b>15.3</b> Transform an element in a custom action button</a></li>
<li class="chapter" data-level="15.4" data-path="custom-templates-interactivity.html"><a href="custom-templates-interactivity.html#tab-events"><i class="fa fa-check"></i><b>15.4</b> Tab events</a><ul>
<li class="chapter" data-level="15.4.1" data-path="custom-templates-interactivity.html"><a href="custom-templates-interactivity.html#insert-tabs"><i class="fa fa-check"></i><b>15.4.1</b> Insert/Remove tabs in tabsetpanel</a></li>
</ul></li>
<li class="chapter" data-level="15.5" data-path="htmltools-overview.html"><a href="htmltools-overview.html#exercises"><i class="fa fa-check"></i><b>15.5</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>Toward a better workflow</b></span></li>
<li class="chapter" data-level="16" data-path="workflow-charpente.html"><a href="workflow-charpente.html"><i class="fa fa-check"></i><b>16</b> Introduction to {charpente}</a><ul>
<li class="chapter" data-level="16.1" data-path="shiny-input-system.html"><a href="shiny-input-system.html#motivations"><i class="fa fa-check"></i><b>16.1</b> Motivations</a></li>
<li class="chapter" data-level="16.2" data-path="workflow-charpente.html"><a href="workflow-charpente.html#step-by-step"><i class="fa fa-check"></i><b>16.2</b> Step by step</a></li>
</ul></li>
<li class="part"><span><b>Beautify with CSS and SASS</b></span></li>
<li class="chapter" data-level="17" data-path="beautify-with-fresh.html"><a href="beautify-with-fresh.html"><i class="fa fa-check"></i><b>17</b> Beautify with fresh</a><ul>
<li class="chapter" data-level="17.1" data-path="beautify-with-fresh.html"><a href="beautify-with-fresh.html#fresh-the-big-picture"><i class="fa fa-check"></i><b>17.1</b> {fresh}, the big picture</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Outstanding User Interfaces with Shiny</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="shiny-intro" class="section level1">
<h1><span class="header-section-number">Chapter 7</span> Shiny’s internal: session and websockets</h1>
<p>In this chapter, we will answer to the following question:</p>
<ul>
<li>How is the R/JavaScript communication achieved?</li>
</ul>
<div class="warningbox">
<p>At this point, users may find <code>options(shiny.minified = FALSE)</code> to debug the Shiny.js core.</p>
</div>
<div id="shiny-websocket" class="section level2">
<h2><span class="header-section-number">7.1</span> Websocket: R/JS bidirectional communication</h2>
<p>How does R (server) and JavaScript (client) communicate? This is a built-in Shiny feature highlighted <a href="https://github.com/rstudio/shiny">here</a>, which leverages the <a href="https://github.com/rstudio/httpuv">httpuv</a> package. Before going further let’s define what is a websocket! It is an advanced technology allowing bidirectional communication between a (or multiple) client(s) and a server. For instance, a <a href="https://dev.to/spukas/learn-websockets-by-building-simple-chat-app-dee">chat</a> system may be built on top of a websocket.<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a> The server is created from <code>{httpuv}</code> <span class="citation">(Cheng and Chang <a href="#ref-R-httpuv" role="doc-biblioref">2020</a>)</span> and the client with <code>{websocket}</code> <span class="citation">(Chang, Cheng, Dipert, et al. <a href="#ref-R-websocket" role="doc-biblioref">2020</a>)</span> or directly from JavaScript, as described below:</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="shiny-intro.html#cb177-1"></a><span class="kw">library</span>(httpuv)</span>
<span id="cb177-2"><a href="shiny-intro.html#cb177-2"></a><span class="co"># set the server</span></span>
<span id="cb177-3"><a href="shiny-intro.html#cb177-3"></a>s &lt;-<span class="st"> </span><span class="kw">startServer</span>(<span class="st">&quot;127.0.0.1&quot;</span>, <span class="dv">8080</span>,</span>
<span id="cb177-4"><a href="shiny-intro.html#cb177-4"></a>  <span class="kw">list</span>(</span>
<span id="cb177-5"><a href="shiny-intro.html#cb177-5"></a>    <span class="dt">onWSOpen =</span> <span class="cf">function</span>(ws) {</span>
<span id="cb177-6"><a href="shiny-intro.html#cb177-6"></a>      <span class="co"># The ws object is a WebSocket object</span></span>
<span id="cb177-7"><a href="shiny-intro.html#cb177-7"></a>      <span class="kw">cat</span>(<span class="st">&quot;Server connection opened.</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb177-8"><a href="shiny-intro.html#cb177-8"></a>      </span>
<span id="cb177-9"><a href="shiny-intro.html#cb177-9"></a>      ws<span class="op">$</span><span class="kw">onMessage</span>(<span class="cf">function</span>(binary, message) {</span>
<span id="cb177-10"><a href="shiny-intro.html#cb177-10"></a>        <span class="kw">cat</span>(<span class="st">&quot;Server received message:&quot;</span>, message, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb177-11"><a href="shiny-intro.html#cb177-11"></a>        ws<span class="op">$</span><span class="kw">send</span>(<span class="st">&quot;Hello client!&quot;</span>)</span>
<span id="cb177-12"><a href="shiny-intro.html#cb177-12"></a>      })</span>
<span id="cb177-13"><a href="shiny-intro.html#cb177-13"></a>      ws<span class="op">$</span><span class="kw">onClose</span>(<span class="cf">function</span>() {</span>
<span id="cb177-14"><a href="shiny-intro.html#cb177-14"></a>        <span class="kw">cat</span>(<span class="st">&quot;Server connection closed.</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb177-15"><a href="shiny-intro.html#cb177-15"></a>      })</span>
<span id="cb177-16"><a href="shiny-intro.html#cb177-16"></a>    }</span>
<span id="cb177-17"><a href="shiny-intro.html#cb177-17"></a>  )</span>
<span id="cb177-18"><a href="shiny-intro.html#cb177-18"></a>)</span></code></pre></div>
<p>On the server side, <code>startServer</code> expects a host, port and an app. In the case of websockets, app is a list containing the <code>onWSOpen</code> function defining all actions to perform after the connection is established. Those actions are defined in the <code>{httpuv}</code> <code>WebSocket</code> R6 class:</p>
<ul>
<li><code>onMessage</code> is invoked whenever a message is received on this connection.</li>
<li><code>onClose</code> is invoked when the connection is closed.</li>
<li><code>send</code> sends a message from the server (to the client).</li>
</ul>
<p>On the client, we may use the <code>{websocket}</code> <code>WebSocket</code> class provided by the <a href="https://github.com/rstudio/websocket">websocket</a> package. As soon as the new socket instance is created, the server <code>onWSOpen</code> function is called which displays the welcome message. Then a message is sent from the client, received on the server and sent back to the client.</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="shiny-intro.html#cb178-1"></a><span class="kw">library</span>(websocket)</span>
<span id="cb178-2"><a href="shiny-intro.html#cb178-2"></a><span class="co"># set the client</span></span>
<span id="cb178-3"><a href="shiny-intro.html#cb178-3"></a>ws &lt;-<span class="st"> </span>websocket<span class="op">::</span>WebSocket<span class="op">$</span><span class="kw">new</span>(<span class="st">&quot;ws://127.0.0.1:8080/&quot;</span>)</span>
<span id="cb178-4"><a href="shiny-intro.html#cb178-4"></a>ws<span class="op">$</span><span class="kw">onMessage</span>(<span class="cf">function</span>(event) {</span>
<span id="cb178-5"><a href="shiny-intro.html#cb178-5"></a>  <span class="kw">cat</span>(<span class="st">&quot;Client received message:&quot;</span>, event<span class="op">$</span>data, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb178-6"><a href="shiny-intro.html#cb178-6"></a>})</span>
<span id="cb178-7"><a href="shiny-intro.html#cb178-7"></a></span>
<span id="cb178-8"><a href="shiny-intro.html#cb178-8"></a><span class="co"># Wait for a moment before running next line</span></span>
<span id="cb178-9"><a href="shiny-intro.html#cb178-9"></a>ws<span class="op">$</span><span class="kw">send</span>(<span class="st">&quot;Hello server!&quot;</span>)</span>
<span id="cb178-10"><a href="shiny-intro.html#cb178-10"></a></span>
<span id="cb178-11"><a href="shiny-intro.html#cb178-11"></a><span class="co"># Close client</span></span>
<span id="cb178-12"><a href="shiny-intro.html#cb178-12"></a>ws<span class="op">$</span><span class="kw">close</span>()</span></code></pre></div>
<p>Note that the client might also be built directly from JS as below, which is actually what shiny does:</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb179-1"><a href="shiny-intro.html#cb179-1"></a><span class="dt">&lt;!DOCTYPE </span>HTML<span class="dt">&gt;</span></span>
<span id="cb179-2"><a href="shiny-intro.html#cb179-2"></a><span class="kw">&lt;html</span><span class="ot"> lang=</span><span class="st">&quot;en&quot;</span><span class="kw">&gt;</span></span>
<span id="cb179-3"><a href="shiny-intro.html#cb179-3"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb179-4"><a href="shiny-intro.html#cb179-4"></a>    <span class="kw">&lt;script</span><span class="ot"> language=</span><span class="st">&quot;javascript&quot;</span><span class="kw">&gt;</span></span>
<span id="cb179-5"><a href="shiny-intro.html#cb179-5"></a>      <span class="co">// displays an alert </span></span>
<span id="cb179-6"><a href="shiny-intro.html#cb179-6"></a>      <span class="kw">var</span> mySocket <span class="op">=</span> <span class="kw">new</span> <span class="at">WebSocket</span>(<span class="st">&quot;ws://127.0.0.1:8080&quot;</span>)<span class="op">;</span></span>
<span id="cb179-7"><a href="shiny-intro.html#cb179-7"></a>      <span class="va">mySocket</span>.<span class="at">onopen</span> <span class="op">=</span> <span class="kw">function</span> (event) <span class="op">{</span></span>
<span id="cb179-8"><a href="shiny-intro.html#cb179-8"></a>        <span class="co">// exampleSocket.send(&quot;Client connected!&quot;); </span></span>
<span id="cb179-9"><a href="shiny-intro.html#cb179-9"></a>      <span class="op">};</span></span>
<span id="cb179-10"><a href="shiny-intro.html#cb179-10"></a>      <span class="va">mySocket</span>.<span class="at">onmessage</span> <span class="op">=</span> <span class="kw">function</span> (event) <span class="op">{</span></span>
<span id="cb179-11"><a href="shiny-intro.html#cb179-11"></a>        <span class="va">console</span>.<span class="at">log</span>(<span class="va">event</span>.<span class="at">data</span>)<span class="op">;</span></span>
<span id="cb179-12"><a href="shiny-intro.html#cb179-12"></a>      <span class="op">};</span></span>
<span id="cb179-13"><a href="shiny-intro.html#cb179-13"></a>    <span class="kw">&lt;/script&gt;</span></span>
<span id="cb179-14"><a href="shiny-intro.html#cb179-14"></a>    <span class="kw">&lt;title&gt;</span>Websocket Example<span class="kw">&lt;/title&gt;</span></span>
<span id="cb179-15"><a href="shiny-intro.html#cb179-15"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb179-16"><a href="shiny-intro.html#cb179-16"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb179-17"><a href="shiny-intro.html#cb179-17"></a>    <span class="co">&lt;!-- onclick attributes applies the JavaScript function changeColor define above --&gt;</span></span>
<span id="cb179-18"><a href="shiny-intro.html#cb179-18"></a>    <span class="kw">&lt;button</span><span class="ot"> onclick=</span><span class="st">&quot;mySocket.send(&#39;Hello server!&#39;)&quot;</span><span class="kw">&gt;</span>Say hello to the server<span class="kw">&lt;/button&gt;</span></span>
<span id="cb179-19"><a href="shiny-intro.html#cb179-19"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb179-20"><a href="shiny-intro.html#cb179-20"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<div class="importantblock">
<p><code>host</code> and <code>port</code> must be identical on both server and client side!</p>
</div>
<p>If you open this file in a web browser, clicking on a button will send a message to the server, as shown on Figure <a href="shiny-intro.html#fig:general-websocket">7.1</a>.</p>
<div class="figure"><span id="fig:general-websocket"></span>
<img src="images/survival-kit/general-websocket.png" alt="Server client communication" width="100%" />
<p class="caption">
FIGURE 7.1: Server client communication
</p>
</div>
<p>The reader must understand that when Shiny input/output are modified on the client by an end user, there are a lot of exchanges between R and JS, through the websocket. In the following, we briefly describe how Shiny leverages this technology, on both server and client side.</p>
<div id="shiny-websocket-server-side" class="section level3">
<h3><span class="header-section-number">7.1.1</span> Shiny: websocket server side</h3>
<div id="websocket-creation" class="section level4">
<h4><span class="header-section-number">7.1.1.1</span> Websocket creation</h4>
<p>On the server, that is R, a websocket is initiated in the <a href="https://github.com/rstudio/shiny/blob/master/R/server.R#L440">startApp</a> function, leveraging the <code>{httpuv}</code> package. In short, a shiny app object is composed of a modified <code>{httpuv}</code> compatible app.
Websocket handlers are <a href="https://github.com/rstudio/shiny/blob/master/R/server.R#L367">defined</a> by <code>handlerManager$addWSHandler(appHandlers$ws, "/", tail = TRUE)</code>.</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="shiny-intro.html#cb180-1"></a><span class="co"># see middleware.R</span></span>
<span id="cb180-2"><a href="shiny-intro.html#cb180-2"></a>httpuvApp &lt;-<span class="st"> </span>handlerManager<span class="op">$</span><span class="kw">createHttpuvApp</span>()</span>
<span id="cb180-3"><a href="shiny-intro.html#cb180-3"></a></span>
<span id="cb180-4"><a href="shiny-intro.html#cb180-4"></a>onWSOpen =<span class="st"> </span><span class="cf">function</span>(ws) {</span>
<span id="cb180-5"><a href="shiny-intro.html#cb180-5"></a>  <span class="kw">return</span>(wsHandlers<span class="op">$</span><span class="kw">invoke</span>(ws))</span>
<span id="cb180-6"><a href="shiny-intro.html#cb180-6"></a>}</span>
<span id="cb180-7"><a href="shiny-intro.html#cb180-7"></a></span>
<span id="cb180-8"><a href="shiny-intro.html#cb180-8"></a>addWSHandler =<span class="st"> </span><span class="cf">function</span>(wsHandler, key, <span class="dt">tail =</span> <span class="ot">FALSE</span>) {</span>
<span id="cb180-9"><a href="shiny-intro.html#cb180-9"></a>  wsHandlers<span class="op">$</span><span class="kw">add</span>(wsHandler, key, tail)</span>
<span id="cb180-10"><a href="shiny-intro.html#cb180-10"></a>}</span>
<span id="cb180-11"><a href="shiny-intro.html#cb180-11"></a></span>
<span id="cb180-12"><a href="shiny-intro.html#cb180-12"></a><span class="co"># server.R (line 281-290)</span></span>
<span id="cb180-13"><a href="shiny-intro.html#cb180-13"></a>ws<span class="op">$</span><span class="kw">onMessage</span>(<span class="cf">function</span>(binary, msg) {</span>
<span id="cb180-14"><a href="shiny-intro.html#cb180-14"></a>  <span class="co"># If unhandled errors occur, make sure they get properly logged</span></span>
<span id="cb180-15"><a href="shiny-intro.html#cb180-15"></a>  <span class="kw">withLogErrors</span>(<span class="kw">messageHandler</span>(binary, msg))</span>
<span id="cb180-16"><a href="shiny-intro.html#cb180-16"></a>})</span>
<span id="cb180-17"><a href="shiny-intro.html#cb180-17"></a></span>
<span id="cb180-18"><a href="shiny-intro.html#cb180-18"></a><span class="co"># Message is first decoded -&gt; See decodeMessage(msg)</span></span>
<span id="cb180-19"><a href="shiny-intro.html#cb180-19"></a></span>
<span id="cb180-20"><a href="shiny-intro.html#cb180-20"></a><span class="co"># Given a unique shinysession, messageHandler has 2 cases: init and update. This depends on the msg$method value. </span></span>
<span id="cb180-21"><a href="shiny-intro.html#cb180-21"></a><span class="co"># When init, input are managed before observers run. On update, we wait for observers to run before. See shinysession$manageInputs(msg$data, now = TRUE) below. </span></span>
<span id="cb180-22"><a href="shiny-intro.html#cb180-22"></a></span>
<span id="cb180-23"><a href="shiny-intro.html#cb180-23"></a><span class="co"># shinysession$manageInputs(msg$data, now = TRUE)</span></span>
<span id="cb180-24"><a href="shiny-intro.html#cb180-24"></a><span class="co"># Set the normal and client data input variables. Normally, managing</span></span>
<span id="cb180-25"><a href="shiny-intro.html#cb180-25"></a><span class="co"># inputs doesn&#39;t take immediate effect when there are observers that</span></span>
<span id="cb180-26"><a href="shiny-intro.html#cb180-26"></a><span class="co"># are pending execution or currently executing (including having</span></span>
<span id="cb180-27"><a href="shiny-intro.html#cb180-27"></a><span class="co"># started async operations that have yielded control, but not yet</span></span>
<span id="cb180-28"><a href="shiny-intro.html#cb180-28"></a><span class="co"># completed). The `now` argument can force this</span></span>
<span id="cb180-29"><a href="shiny-intro.html#cb180-29"></a></span>
<span id="cb180-30"><a href="shiny-intro.html#cb180-30"></a>manageInputs =<span class="st"> </span><span class="cf">function</span>(data, <span class="dt">now =</span> <span class="ot">FALSE</span>) {</span>
<span id="cb180-31"><a href="shiny-intro.html#cb180-31"></a>  <span class="co"># ... normal inputs are located in private</span></span>
<span id="cb180-32"><a href="shiny-intro.html#cb180-32"></a>}</span>
<span id="cb180-33"><a href="shiny-intro.html#cb180-33"></a></span>
<span id="cb180-34"><a href="shiny-intro.html#cb180-34"></a>ws<span class="op">$</span><span class="kw">onClose</span>(<span class="cf">function</span>() {</span>
<span id="cb180-35"><a href="shiny-intro.html#cb180-35"></a>  shinysession<span class="op">$</span><span class="kw">wsClosed</span>()</span>
<span id="cb180-36"><a href="shiny-intro.html#cb180-36"></a>  appsByToken<span class="op">$</span><span class="kw">remove</span>(shinysession<span class="op">$</span>token)</span>
<span id="cb180-37"><a href="shiny-intro.html#cb180-37"></a>  appsNeedingFlush<span class="op">$</span><span class="kw">remove</span>(shinysession<span class="op">$</span>token)</span>
<span id="cb180-38"><a href="shiny-intro.html#cb180-38"></a>})</span></code></pre></div>
<p>Note that the R option <code>options(shiny.trace = TRUE)</code> allows the websocket messages to be displayed directly in the R console.</p>
</div>
<div id="shiny-session" class="section level4">
<h4><span class="header-section-number">7.1.1.2</span> The Shiny session object</h4>
<p>We won’t be able to go anywhere without giving some reminders about the Shiny <a href="https://shiny.rstudio.com/reference/shiny/1.4.0/session.html">session</a> object. Why do we say object? <code>session</code> is actually an instance of the <a href="https://github.com/rstudio/shiny/blob/master/R/shiny.R"><code>ShinySession</code></a> R6 class.
The initialization takes one parameter, namely the websocket. As shown in the last section, the websocket allows bidirectional exchanges between R and JS. Understanding how R and JS communicate allows us to discuss the Shiny input system.</p>
<ul>
<li><code>sendCustomMessage</code> sends messages from R to JS. It calls the private <code>sendMessage</code> method which itself calls <code>write</code>. The message is sent only when the session is opened, through the websocket <code>private$websocket$send(json)</code>. If the <code>shiny.trace</code> <a href="https://shiny.rstudio.com/reference/shiny/0.14/shiny-options.html">option</a> is TRUE, a message showing the sent JSON is displayed, which is useful for debugging.</li>
<li><code>sendInputMessage</code> is used to update inputs from the server. The message is stored in a message queue and ultimately sent through the websocket <code>private$websocket$send(json)</code>.</li>
</ul>
<p>The below code is extracted from the <code>shiny.R</code> <a href="https://github.com/rstudio/shiny/blob/master/R/shiny.R">file</a>.</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="shiny-intro.html#cb181-1"></a>sendCustomMessage =<span class="st"> </span><span class="cf">function</span>(type, message) {</span>
<span id="cb181-2"><a href="shiny-intro.html#cb181-2"></a>  data &lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb181-3"><a href="shiny-intro.html#cb181-3"></a>  data[[type]] &lt;-<span class="st"> </span>message</span>
<span id="cb181-4"><a href="shiny-intro.html#cb181-4"></a>  private<span class="op">$</span><span class="kw">sendMessage</span>(<span class="dt">custom =</span> data)</span>
<span id="cb181-5"><a href="shiny-intro.html#cb181-5"></a>}</span>
<span id="cb181-6"><a href="shiny-intro.html#cb181-6"></a></span>
<span id="cb181-7"><a href="shiny-intro.html#cb181-7"></a>sendInputMessage =<span class="st"> </span><span class="cf">function</span>(inputId, message) {</span>
<span id="cb181-8"><a href="shiny-intro.html#cb181-8"></a>  data &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">id =</span> inputId, <span class="dt">message =</span> message)</span>
<span id="cb181-9"><a href="shiny-intro.html#cb181-9"></a>  </span>
<span id="cb181-10"><a href="shiny-intro.html#cb181-10"></a>  <span class="co"># Add to input message queue</span></span>
<span id="cb181-11"><a href="shiny-intro.html#cb181-11"></a>  private<span class="op">$</span>inputMessageQueue[[<span class="kw">length</span>(private<span class="op">$</span>inputMessageQueue) <span class="op">+</span><span class="st"> </span><span class="dv">1</span>]] &lt;-<span class="st"> </span>data</span>
<span id="cb181-12"><a href="shiny-intro.html#cb181-12"></a>  <span class="co"># Needed so that Shiny knows to actually flush the input message queue</span></span>
<span id="cb181-13"><a href="shiny-intro.html#cb181-13"></a>  self<span class="op">$</span><span class="kw">requestFlush</span>()</span>
<span id="cb181-14"><a href="shiny-intro.html#cb181-14"></a>}</span>
<span id="cb181-15"><a href="shiny-intro.html#cb181-15"></a></span>
<span id="cb181-16"><a href="shiny-intro.html#cb181-16"></a></span>
<span id="cb181-17"><a href="shiny-intro.html#cb181-17"></a>sendMessage =<span class="st"> </span><span class="cf">function</span>(...) {</span>
<span id="cb181-18"><a href="shiny-intro.html#cb181-18"></a>  <span class="co"># This function is a wrapper for $write</span></span>
<span id="cb181-19"><a href="shiny-intro.html#cb181-19"></a>  msg &lt;-<span class="st"> </span><span class="kw">list</span>(...)</span>
<span id="cb181-20"><a href="shiny-intro.html#cb181-20"></a>  <span class="cf">if</span> (<span class="kw">anyUnnamed</span>(msg)) {</span>
<span id="cb181-21"><a href="shiny-intro.html#cb181-21"></a>    <span class="kw">stop</span>(<span class="st">&quot;All arguments to sendMessage must be named.&quot;</span>)</span>
<span id="cb181-22"><a href="shiny-intro.html#cb181-22"></a>  }</span>
<span id="cb181-23"><a href="shiny-intro.html#cb181-23"></a>  private<span class="op">$</span><span class="kw">write</span>(<span class="kw">toJSON</span>(msg))</span>
<span id="cb181-24"><a href="shiny-intro.html#cb181-24"></a>}</span>
<span id="cb181-25"><a href="shiny-intro.html#cb181-25"></a></span>
<span id="cb181-26"><a href="shiny-intro.html#cb181-26"></a></span>
<span id="cb181-27"><a href="shiny-intro.html#cb181-27"></a>write =<span class="st"> </span><span class="cf">function</span>(json) {</span>
<span id="cb181-28"><a href="shiny-intro.html#cb181-28"></a>  <span class="cf">if</span> (self<span class="op">$</span>closed){</span>
<span id="cb181-29"><a href="shiny-intro.html#cb181-29"></a>    <span class="kw">return</span>()</span>
<span id="cb181-30"><a href="shiny-intro.html#cb181-30"></a>  }</span>
<span id="cb181-31"><a href="shiny-intro.html#cb181-31"></a>  traceOption &lt;-<span class="st"> </span><span class="kw">getOption</span>(<span class="st">&#39;shiny.trace&#39;</span>, <span class="ot">FALSE</span>)</span>
<span id="cb181-32"><a href="shiny-intro.html#cb181-32"></a>  <span class="cf">if</span> (<span class="kw">isTRUE</span>(traceOption) <span class="op">||</span><span class="st"> </span>traceOption <span class="op">==</span><span class="st"> &quot;send&quot;</span>)</span>
<span id="cb181-33"><a href="shiny-intro.html#cb181-33"></a>    <span class="kw">message</span>(<span class="st">&#39;SEND &#39;</span>,</span>
<span id="cb181-34"><a href="shiny-intro.html#cb181-34"></a>            <span class="kw">gsub</span>(<span class="st">&#39;(?m)base64,[a-zA-Z0-9+/=]+&#39;</span>,<span class="st">&#39;[base64 data]&#39;</span>,json,<span class="dt">perl=</span><span class="ot">TRUE</span>))</span>
<span id="cb181-35"><a href="shiny-intro.html#cb181-35"></a>  private<span class="op">$</span>websocket<span class="op">$</span><span class="kw">send</span>(json)</span>
<span id="cb181-36"><a href="shiny-intro.html#cb181-36"></a>}</span>
<span id="cb181-37"><a href="shiny-intro.html#cb181-37"></a><span class="co"># ...</span></span></code></pre></div>
<p>No worry if it is not clear at the moment. We will discuss those elements in the following sections.</p>
</div>
</div>
<div id="shiny-websocket-client-side" class="section level3">
<h3><span class="header-section-number">7.1.2</span> Shiny: Websocket client side</h3>
<p>On the JS side, the socket creation occurs in the <code>shinyapps.js</code> <a href="https://github.com/rstudio/shiny/blob/master/srcjs/shinyapp.js#L58">file</a>:</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb182-1"><a href="shiny-intro.html#cb182-1"></a><span class="kw">var</span> ws <span class="op">=</span> <span class="kw">new</span> <span class="at">WebSocket</span>(protocol <span class="op">+</span> <span class="st">&#39;//&#39;</span> <span class="op">+</span> <span class="va">window</span>.<span class="va">location</span>.<span class="at">host</span> <span class="op">+</span> defaultPath)<span class="op">;</span></span></code></pre></div>
<p>through the <code>WebSocket</code> object. <code>protocol</code> is the chosen protocol (either <code>ws</code> or <code>wss</code> if using <code>https</code>). <code>window.location.host</code> contains the host name and its <a href="https://developer.mozilla.org/fr/docs/Web/API/window/location">port</a>.
Once the connection is opened, events are handled with the <code>onopen</code> event registry:</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb183-1"><a href="shiny-intro.html#cb183-1"></a><span class="va">socket</span>.<span class="at">onopen</span> <span class="op">=</span> <span class="kw">function</span>() <span class="op">{</span></span>
<span id="cb183-2"><a href="shiny-intro.html#cb183-2"></a>  hasOpened <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb183-3"><a href="shiny-intro.html#cb183-3"></a></span>
<span id="cb183-4"><a href="shiny-intro.html#cb183-4"></a>  <span class="at">$</span>(document).<span class="at">trigger</span>(<span class="op">{</span></span>
<span id="cb183-5"><a href="shiny-intro.html#cb183-5"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;shiny:connected&#39;</span><span class="op">,</span></span>
<span id="cb183-6"><a href="shiny-intro.html#cb183-6"></a>    <span class="dt">socket</span><span class="op">:</span> socket</span>
<span id="cb183-7"><a href="shiny-intro.html#cb183-7"></a>  <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb183-8"><a href="shiny-intro.html#cb183-8"></a></span>
<span id="cb183-9"><a href="shiny-intro.html#cb183-9"></a>  <span class="va">self</span>.<span class="at">onConnected</span>()<span class="op">;</span> <span class="co">// remove overlay</span></span>
<span id="cb183-10"><a href="shiny-intro.html#cb183-10"></a></span>
<span id="cb183-11"><a href="shiny-intro.html#cb183-11"></a>  <span class="va">socket</span>.<span class="at">send</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(<span class="op">{</span></span>
<span id="cb183-12"><a href="shiny-intro.html#cb183-12"></a>    <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;init&#39;</span><span class="op">,</span></span>
<span id="cb183-13"><a href="shiny-intro.html#cb183-13"></a>    <span class="dt">data</span><span class="op">:</span> <span class="va">self</span>.<span class="at">$initialInput</span></span>
<span id="cb183-14"><a href="shiny-intro.html#cb183-14"></a>  <span class="op">}</span>))<span class="op">;</span></span>
<span id="cb183-15"><a href="shiny-intro.html#cb183-15"></a></span>
<span id="cb183-16"><a href="shiny-intro.html#cb183-16"></a>  <span class="cf">while</span> (<span class="va">self</span>.<span class="va">$pendingMessages</span>.<span class="at">length</span>) <span class="op">{</span></span>
<span id="cb183-17"><a href="shiny-intro.html#cb183-17"></a>    <span class="kw">var</span> msg <span class="op">=</span> <span class="va">self</span>.<span class="va">$pendingMessages</span>.<span class="at">shift</span>()<span class="op">;</span></span>
<span id="cb183-18"><a href="shiny-intro.html#cb183-18"></a>    <span class="va">socket</span>.<span class="at">send</span>(msg)<span class="op">;</span></span>
<span id="cb183-19"><a href="shiny-intro.html#cb183-19"></a>  <span class="op">}</span></span>
<span id="cb183-20"><a href="shiny-intro.html#cb183-20"></a><span class="op">}</span></span></code></pre></div>
<p>The <code>shiny:connected</code> event is triggered, any disconnected overlay (the famous grayed out screen) is then removed from the DOM. Initial input values are sent to the server via the <code>send</code> method. The <code>onmessage</code> registry aims at handling messages received from the server.</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb184-1"><a href="shiny-intro.html#cb184-1"></a><span class="va">socket</span>.<span class="at">onmessage</span> <span class="op">=</span> <span class="kw">function</span>(e) <span class="op">{</span></span>
<span id="cb184-2"><a href="shiny-intro.html#cb184-2"></a>  <span class="va">self</span>.<span class="at">dispatchMessage</span>(<span class="va">e</span>.<span class="at">data</span>)<span class="op">;</span></span>
<span id="cb184-3"><a href="shiny-intro.html#cb184-3"></a><span class="op">};</span></span></code></pre></div>
<p>It subsequently invokes the <code>dispatchMessage</code> method that sends message to all handlers (through <code>_sendMessagesToHandlers</code>), triggering the <code>shiny:message</code> event. Shiny has internal and custom provided handlers (understand user-defined) stored in separate arrays. Each time, a message type matches an handler, it is treated. For instance, there is a dedicated internal handler for input messages, that bridges the gap between a given input and the corresponding input binding. This handler eventually triggers the <code>inputBinding.receiveMessage</code> method so that the input value is updated on the client.</p>
<p>Finally the <code>onclose</code> method is called when the websocket connection is closed.</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb185-1"><a href="shiny-intro.html#cb185-1"></a><span class="va">socket</span>.<span class="at">onclose</span> <span class="op">=</span> <span class="kw">function</span>() <span class="op">{</span></span>
<span id="cb185-2"><a href="shiny-intro.html#cb185-2"></a>      <span class="co">// These things are needed only if we&#39;ve successfully opened the</span></span>
<span id="cb185-3"><a href="shiny-intro.html#cb185-3"></a>      <span class="co">// websocket.</span></span>
<span id="cb185-4"><a href="shiny-intro.html#cb185-4"></a>  <span class="cf">if</span> (hasOpened) <span class="op">{</span></span>
<span id="cb185-5"><a href="shiny-intro.html#cb185-5"></a>    <span class="at">$</span>(document).<span class="at">trigger</span>(<span class="op">{</span></span>
<span id="cb185-6"><a href="shiny-intro.html#cb185-6"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;shiny:disconnected&#39;</span><span class="op">,</span></span>
<span id="cb185-7"><a href="shiny-intro.html#cb185-7"></a>      <span class="dt">socket</span><span class="op">:</span> socket</span>
<span id="cb185-8"><a href="shiny-intro.html#cb185-8"></a>    <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb185-9"><a href="shiny-intro.html#cb185-9"></a></span>
<span id="cb185-10"><a href="shiny-intro.html#cb185-10"></a>    <span class="va">self</span>.<span class="at">$notifyDisconnected</span>()<span class="op">;</span></span>
<span id="cb185-11"><a href="shiny-intro.html#cb185-11"></a>  <span class="op">}</span></span>
<span id="cb185-12"><a href="shiny-intro.html#cb185-12"></a></span>
<span id="cb185-13"><a href="shiny-intro.html#cb185-13"></a>  <span class="va">self</span>.<span class="at">onDisconnected</span>()<span class="op">;</span> <span class="co">// Must be run before self.$removeSocket()</span></span>
<span id="cb185-14"><a href="shiny-intro.html#cb185-14"></a>  <span class="va">self</span>.<span class="at">$removeSocket</span>()<span class="op">;</span></span>
<span id="cb185-15"><a href="shiny-intro.html#cb185-15"></a><span class="op">}</span></span></code></pre></div>
<p>If the connection was open, the <code>shiny:disconnected</code> event is triggered. Then, the disconnect overlay is added to the DOM (grayed out screen) and the socket is removed.</p>
</div>
<div id="example" class="section level3">
<h3><span class="header-section-number">7.1.3</span> Example</h3>
<p>In the following, we will show how to inspect the websocket in a web browser. Let’s run the following app (see <a href="shiny-intro.html#fig:shiny-websocket">7.2</a>, left panel)</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="shiny-intro.html#cb186-1"></a><span class="kw">library</span>(shiny)</span>
<span id="cb186-2"><a href="shiny-intro.html#cb186-2"></a><span class="kw">shinyApp</span>(</span>
<span id="cb186-3"><a href="shiny-intro.html#cb186-3"></a>  <span class="dt">ui =</span> <span class="kw">fluidPage</span>(</span>
<span id="cb186-4"><a href="shiny-intro.html#cb186-4"></a>    <span class="kw">selectInput</span>(<span class="st">&quot;variable&quot;</span>, <span class="st">&quot;Variable:&quot;</span>,</span>
<span id="cb186-5"><a href="shiny-intro.html#cb186-5"></a>                <span class="kw">c</span>(<span class="st">&quot;Cylinders&quot;</span> =<span class="st"> &quot;cyl&quot;</span>,</span>
<span id="cb186-6"><a href="shiny-intro.html#cb186-6"></a>                  <span class="st">&quot;Transmission&quot;</span> =<span class="st"> &quot;am&quot;</span>,</span>
<span id="cb186-7"><a href="shiny-intro.html#cb186-7"></a>                  <span class="st">&quot;Gears&quot;</span> =<span class="st"> &quot;gear&quot;</span>)),</span>
<span id="cb186-8"><a href="shiny-intro.html#cb186-8"></a>    <span class="kw">tableOutput</span>(<span class="st">&quot;data&quot;</span>)</span>
<span id="cb186-9"><a href="shiny-intro.html#cb186-9"></a>  ),</span>
<span id="cb186-10"><a href="shiny-intro.html#cb186-10"></a>  <span class="dt">server =</span> <span class="cf">function</span>(input, output) {</span>
<span id="cb186-11"><a href="shiny-intro.html#cb186-11"></a>    output<span class="op">$</span>data &lt;-<span class="st"> </span><span class="kw">renderTable</span>({</span>
<span id="cb186-12"><a href="shiny-intro.html#cb186-12"></a>      mtcars[, <span class="kw">c</span>(<span class="st">&quot;mpg&quot;</span>, input<span class="op">$</span>variable), drop =<span class="st"> </span><span class="ot">FALSE</span>]</span>
<span id="cb186-13"><a href="shiny-intro.html#cb186-13"></a>    }, <span class="dt">rownames =</span> <span class="ot">TRUE</span>)</span>
<span id="cb186-14"><a href="shiny-intro.html#cb186-14"></a>  }</span>
<span id="cb186-15"><a href="shiny-intro.html#cb186-15"></a>)</span></code></pre></div>
<p>After opening the HTML inspector, we select the network tab and search for websocket in the list. By choosing the message tab, you may inspect what R and JavaScript say to each others. As stated above, the first message sent contains initial input values. Then Shiny recalculates the table, notify when the recalculation is done and becomes idle. The second message received from R is after updating the select input, which triggers the same event cycle.</p>
<p>Although complex, it is extremely useful to check whether the input / output communication are working properly. If not, we would see the error field identifying the issue.</p>
<p><code>Shiny.shinyapp.$socket.readyState</code> returns the state of the socket connection. It should be 1 if your app is running. In some instances when the socket is closed, an error would be raised.</p>
<div class="figure"><span id="fig:shiny-websocket"></span>
<img src="images/survival-kit/shiny-websocket.png" alt="Shiny websocket" width="100%" />
<p class="caption">
FIGURE 7.2: Shiny websocket
</p>
</div>
<p>We see below that we can even bypass the UI element and update the input value directly via the websocket using <code>Shiny.shinyapp.$sendMsg</code> with the <code>update</code> method.</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="shiny-intro.html#cb187-1"></a>updateObsVal &lt;-<span class="st"> </span><span class="cf">function</span>(value) {</span>
<span id="cb187-2"><a href="shiny-intro.html#cb187-2"></a>  <span class="kw">sprintf</span>(</span>
<span id="cb187-3"><a href="shiny-intro.html#cb187-3"></a>    <span class="st">&quot;Shiny.shinyapp.$sendMsg(JSON.stringify({</span></span>
<span id="cb187-4"><a href="shiny-intro.html#cb187-4"></a><span class="st">      method: &#39;update&#39;,</span></span>
<span id="cb187-5"><a href="shiny-intro.html#cb187-5"></a><span class="st">      data: {obs: %s}</span></span>
<span id="cb187-6"><a href="shiny-intro.html#cb187-6"></a><span class="st">    }));&quot;</span>,</span>
<span id="cb187-7"><a href="shiny-intro.html#cb187-7"></a>    value</span>
<span id="cb187-8"><a href="shiny-intro.html#cb187-8"></a>  )</span>
<span id="cb187-9"><a href="shiny-intro.html#cb187-9"></a>}</span>
<span id="cb187-10"><a href="shiny-intro.html#cb187-10"></a></span>
<span id="cb187-11"><a href="shiny-intro.html#cb187-11"></a><span class="co"># below we shunt the slider input by sending message</span></span>
<span id="cb187-12"><a href="shiny-intro.html#cb187-12"></a><span class="co"># directly through the websocket</span></span>
<span id="cb187-13"><a href="shiny-intro.html#cb187-13"></a></span>
<span id="cb187-14"><a href="shiny-intro.html#cb187-14"></a>ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(</span>
<span id="cb187-15"><a href="shiny-intro.html#cb187-15"></a>  tags<span class="op">$</span><span class="kw">button</span>(</span>
<span id="cb187-16"><a href="shiny-intro.html#cb187-16"></a>    <span class="st">&quot;Update obs value&quot;</span>,</span>
<span id="cb187-17"><a href="shiny-intro.html#cb187-17"></a>    <span class="dt">onclick =</span> <span class="kw">updateObsVal</span>(<span class="dv">4</span>)</span>
<span id="cb187-18"><a href="shiny-intro.html#cb187-18"></a>  ),</span>
<span id="cb187-19"><a href="shiny-intro.html#cb187-19"></a>  <span class="kw">sliderInput</span>(<span class="st">&quot;obs&quot;</span>, <span class="st">&quot;Number of observations:&quot;</span>,</span>
<span id="cb187-20"><a href="shiny-intro.html#cb187-20"></a>              <span class="dt">min =</span> <span class="dv">0</span>, <span class="dt">max =</span> <span class="dv">1000</span>, <span class="dt">value =</span> <span class="dv">500</span></span>
<span id="cb187-21"><a href="shiny-intro.html#cb187-21"></a>  ),</span>
<span id="cb187-22"><a href="shiny-intro.html#cb187-22"></a>  <span class="kw">plotOutput</span>(<span class="st">&quot;distPlot&quot;</span>)</span>
<span id="cb187-23"><a href="shiny-intro.html#cb187-23"></a>)</span>
<span id="cb187-24"><a href="shiny-intro.html#cb187-24"></a></span>
<span id="cb187-25"><a href="shiny-intro.html#cb187-25"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {</span>
<span id="cb187-26"><a href="shiny-intro.html#cb187-26"></a>  output<span class="op">$</span>distPlot &lt;-<span class="st"> </span><span class="kw">renderPlot</span>({</span>
<span id="cb187-27"><a href="shiny-intro.html#cb187-27"></a>    <span class="kw">hist</span>(<span class="kw">rnorm</span>(input<span class="op">$</span>obs))</span>
<span id="cb187-28"><a href="shiny-intro.html#cb187-28"></a>  })</span>
<span id="cb187-29"><a href="shiny-intro.html#cb187-29"></a>}</span>
<span id="cb187-30"><a href="shiny-intro.html#cb187-30"></a></span>
<span id="cb187-31"><a href="shiny-intro.html#cb187-31"></a><span class="kw">shinyApp</span>(ui, server)</span></code></pre></div>
</div>
</div>
<div id="shiny-js-object" class="section level2">
<h2><span class="header-section-number">7.2</span> The Shiny JavaScript object</h2>
<p>The <code>Shiny</code> object is exported at the top of the <code>shiny.js</code> file.<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a> In other words, this means that we may use this object and any of its properties within the HTML inspector console tab, in any JavaScript file or shiny app as below.</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="shiny-intro.html#cb188-1"></a>ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(</span>
<span id="cb188-2"><a href="shiny-intro.html#cb188-2"></a>  tags<span class="op">$</span><span class="kw">script</span>(</span>
<span id="cb188-3"><a href="shiny-intro.html#cb188-3"></a>    <span class="st">&quot;$(function() {</span></span>
<span id="cb188-4"><a href="shiny-intro.html#cb188-4"></a><span class="st">      console.log(Shiny);</span></span>
<span id="cb188-5"><a href="shiny-intro.html#cb188-5"></a><span class="st">    });</span></span>
<span id="cb188-6"><a href="shiny-intro.html#cb188-6"></a><span class="st">    &quot;</span></span>
<span id="cb188-7"><a href="shiny-intro.html#cb188-7"></a>  )</span>
<span id="cb188-8"><a href="shiny-intro.html#cb188-8"></a>)</span>
<span id="cb188-9"><a href="shiny-intro.html#cb188-9"></a>server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {}</span>
<span id="cb188-10"><a href="shiny-intro.html#cb188-10"></a><span class="kw">shinyApp</span>(ui, server)</span></code></pre></div>
<p>This object contains many properties and methods as shown in Figure <a href="shiny-intro.html#fig:shiny-object">7.3</a>. Some of particular interest, such as like <code>Shiny.setInputValue</code>, <code>Shiny.addCustomMessageHandler</code>, <code>Shiny.shinyapps</code>, <code>Shiny.bindAll</code>, … will be detailed later.</p>
<div class="figure"><span id="fig:shiny-object"></span>
<img src="images/survival-kit/shiny-object.png" alt="The Shiny JavaScript object" width="100%" />
<p class="caption">
FIGURE 7.3: The Shiny JavaScript object
</p>
</div>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-R-websocket">
<p>Chang, Winston, Joe Cheng, Alan Dipert, and Barbara Borges. 2020. <em>Websocket: ’WebSocket’ Client Library</em>. <a href="https://CRAN.R-project.org/package=websocket">https://CRAN.R-project.org/package=websocket</a>.</p>
</div>
<div id="ref-R-httpuv">
<p>Cheng, Joe, and Winston Chang. 2020. <em>Httpuv: HTTP and Websocket Server Library</em>. <a href="https://CRAN.R-project.org/package=httpuv">https://CRAN.R-project.org/package=httpuv</a>.</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="3">
<li id="fn3"><p>Note that by default, each time a client connects to the server, a new connection is open, meaning that this client cannot captures other connections messages. This is also called single cast. For a chat, we want a <a href="https://medium.com/the-quarter-espresso/multicast-websocket-nodejs-ff1f400ba2f7">multi cast</a> option, that is forwarding one client message to (all) other connected clients. <code>{httpuv}</code> does not provide such a feature since this would not make sense and would be harmful in the context of shiny!<a href="shiny-intro.html#fnref3" class="footnote-back">↩︎</a></p></li>
<li id="fn4"><p>Refer to Chapter <a href="survival-kit-javascript.html#survival-kit-javascript">6</a> if you don’t remember how to export an object and make it available to all JS files.<a href="shiny-intro.html#fnref4" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="survival-kit-javascript.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="shiny-input-system.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": {}
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/DivadNojnarg/outstanding-shiny-ui/edit/master/shiny-intro.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": {},
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
